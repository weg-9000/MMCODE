"""add_sessions_pentesting_relationship

Revision ID: baf67a04783a
Revises: c5ae20a2a317
Create Date: 2025-12-04 01:32:16.099866

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'baf67a04783a'
down_revision: Union[str, Sequence[str], None] = 'c5ae20a2a317'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # Add foreign key from pentesting_sessions to sessions
    op.add_column('pentesting_sessions', 
                  sa.Column('base_session_id', sa.String(), nullable=True))
    
    op.create_foreign_key(
        'fk_pentesting_sessions_base_session_id',
        'pentesting_sessions', 'sessions',
        ['base_session_id'], ['id']
    )
    
    # Add index for performance
    op.create_index(
        'ix_pentesting_sessions_base_session_id',
        'pentesting_sessions', 
        ['base_session_id']
    )
    
    # Update existing pentesting sessions to link with sessions where possible
    # This is a safe operation that won't break existing data
    op.execute("""
        UPDATE pentesting_sessions 
        SET base_session_id = (
            SELECT s.id 
            FROM sessions s 
            WHERE s.created_at::date = pentesting_sessions.created_at::date 
            AND s.title ILIKE '%' || pentesting_sessions.session_name || '%'
            LIMIT 1
        )
        WHERE base_session_id IS NULL
    """)


def downgrade() -> None:
    """Downgrade schema."""
    # Remove foreign key and column
    op.drop_index('ix_pentesting_sessions_base_session_id', table_name='pentesting_sessions')
    op.drop_constraint('fk_pentesting_sessions_base_session_id', 'pentesting_sessions', type_='foreignkey')
    op.drop_column('pentesting_sessions', 'base_session_id')
