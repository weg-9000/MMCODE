# MMCODE Security Sandbox Supervisor Configuration
# ===============================================
#
# Process management for security sandbox environment
# - Monitor tool runner service
# - Handle graceful shutdowns
# - Maintain service availability

[supervisord]
nodaemon=true
silent=false
user=mmcode-runner
logfile=/tmp/scan-results/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=3
loglevel=info
pidfile=/tmp/supervisord.pid
minfds=1024
minprocs=200
umask=022
identifier=mmcode-sandbox-supervisor

[unix_http_server]
file=/tmp/supervisor.sock
chmod=0700
chown=mmcode-runner:mmcode-runner

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

# Main tool runner process
[program:tool-runner]
command=/usr/bin/python3 /opt/security-tools/tool-runner.py
directory=/home/mmcode-runner
user=mmcode-runner
autostart=true
autorestart=true
startretries=3
startsecs=10
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=30
killasgroup=true
stopasgroup=true
stdout_logfile=/tmp/scan-results/logs/tool-runner-stdout.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=3
stderr_logfile=/tmp/scan-results/logs/tool-runner-stderr.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=3
redirect_stderr=false
environment=PYTHONUNBUFFERED=1,MMCODE_LOG_LEVEL=INFO

# Resource monitoring process
[program:resource-monitor]
command=/usr/bin/python3 /opt/security-tools/resource-monitor.py
directory=/home/mmcode-runner
user=mmcode-runner
autostart=true
autorestart=true
startretries=3
startsecs=5
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=10
stdout_logfile=/tmp/scan-results/logs/resource-monitor-stdout.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile=/tmp/scan-results/logs/resource-monitor-stderr.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=2
redirect_stderr=false
priority=999

# Network validation service
[program:network-validator]
command=/usr/bin/python3 /opt/security-tools/network-validator.py
directory=/home/mmcode-runner
user=mmcode-runner
autostart=true
autorestart=true
startretries=3
startsecs=5
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=10
stdout_logfile=/tmp/scan-results/logs/network-validator-stdout.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile=/tmp/scan-results/logs/network-validator-stderr.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=2
redirect_stderr=false
priority=998

# Log rotation service
[program:log-rotator]
command=/bin/bash -c 'while true; do find /tmp/scan-results/logs -name "*.log" -size +100M -exec truncate -s 50M {} \; ; sleep 3600; done'
directory=/home/mmcode-runner
user=mmcode-runner
autostart=true
autorestart=true
startretries=3
startsecs=5
exitcodes=0,2
stopsignal=TERM
stopwaitsecs=5
stdout_logfile=/dev/null
stderr_logfile=/dev/null
redirect_stderr=true
priority=900

# System health checker
[program:health-checker]
command=/usr/bin/python3 /opt/security-tools/healthcheck.py --daemon
directory=/home/mmcode-runner
user=mmcode-runner
autostart=true
autorestart=true
startretries=3
startsecs=10
exitcodes=0
stopsignal=TERM
stopwaitsecs=10
stdout_logfile=/tmp/scan-results/logs/health-checker-stdout.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile=/tmp/scan-results/logs/health-checker-stderr.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=2
redirect_stderr=false
priority=950

[group:mmcode-services]
programs=tool-runner,resource-monitor,network-validator
priority=999